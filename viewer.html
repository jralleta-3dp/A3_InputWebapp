<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sample Name</title>
  <style>
    /* --- Dashboard-inspired global background and container --- */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(ellipse at 60% 0%, #e6f4ea 0%, #f6f8fa 80%);
      color: #24292e;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .container {
      background-color: #fff;
      border-radius: 16px;
      box-shadow:
        0 8px 32px rgba(0,0,0,0.13),
        0 1.5px 8px 0 rgba(44,162,78,0.08),
        0 0.5px 1.5px 0 rgba(33,136,56,0.10);
      padding: 32px 32px 24px 32px;
      max-width: 600px;
      width: 100%;
      margin: 32px auto 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border: 1.5px solid transparent;
      background-clip: padding-box;
      position: relative;
      z-index: 1;
    }
    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: -1;
      border-radius: 18px;
      padding: 2px;
      background: linear-gradient(120deg, #2da44e 0%, #e1e4e8 100%);
      opacity: 0.13;
      pointer-events: none;
    }
    .static-header {
      position: sticky;
      top: 0;
      background: transparent; /* Make header background transparent */
      z-index: 10;
      padding-bottom: 10px;
      border-bottom: 2px solid #d0d7de;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      box-sizing: border-box;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      box-shadow: none; /* Remove dropshadow */
    }
    .static-header h1 {
      margin: 0 10px;
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 2em;
      line-height: 1.2;
      text-align: center;
      flex: 1 1 auto;
      font-weight: bold;
      color: #24292e;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 8px rgba(44, 162, 78, 0.07);
    }
    .header-btn {
      background: linear-gradient(90deg, #2da44e 60%, #218838 100%);
      color: #fff;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(44, 162, 78, 0.08), 0 1.5px 6px 0 rgba(33,136,56,0.10);
      font-family: inherit;
      font-size: 1.1em;
      font-weight: 700;
      min-width: 60px;
      transition: background 0.18s, transform 0.13s, box-shadow 0.18s;
      outline: none;
      text-shadow: 0 1px 4px rgba(33,136,56,0.10);
    }
    .header-btn:hover, .header-btn:focus {
      background: linear-gradient(90deg, #218838 60%, #2da44e 100%);
      transform: translateY(-2px) scale(1.035);
      box-shadow: 0 6px 18px rgba(44, 162, 78, 0.13), 0 2px 8px rgba(33,136,56,0.12), 0 0 12px 2px #2da44e33;
    }
    .header-btn:active {
      transform: scale(0.98);
    }
    #evaInfo {
      text-align: center;
      padding: 12px;
      color: #586069;
      font-size: 1.1em;
      font-weight: 500;
      letter-spacing: 0.2px;
    }
    #pageCount {
      color: #218838;
      font-weight: bold;
    }
    .column-list {
      display: flex;
      flex-direction: column;
      width: 100%;
      gap: 0;
    }
    .column-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 10px;
      font-size: 1.1em;
      border-bottom: 1px solid #d0d7de;
      background: none;
    }
    .column-item:last-child {
      border-bottom: none;
    }
    .column-name {
      width: 50%;
      text-align: center;
      font-weight: 600;
      color: #24292e;
    }
    .empty-cell {
      width: 50%;
      text-align: right;
      border-left: 1px solid #d0d7de;
      padding: 15px 10px;
      color: #218838;
      font-weight: 500;
      background: none;
    }
    .flash-green {
      background-color: #b6fcb6 !important;
      transition: background-color 0.5s;
    }
    /* Responsive for mobile */
    @media (max-width: 700px) {
      .container {
        padding: 18px 2vw 12px 2vw;
        max-width: 99vw;
      }
      .static-header h1 {
        font-size: 1.2em;
      }
      .header-btn {
        font-size: 1em;
        padding: 8px 12px;
      }
      .column-item {
        font-size: 1em;
        padding: 10px 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="static-header">
      <button id="backButton" class="header-btn">&lt;</button>
      <h1>Sample Name</h1>
      <button id="forwardButton" class="header-btn">&gt;</button>
    </div>
    <div id="evaInfo">
      EVA __ Station __ Sample# __ of __
    </div>
    <div style="text-align: center; margin-top: 10px;color: #d0d7de;">
      # <span id="pageCount">1</span>
    </div>
  </div>

  <div class="container">
    <div class="column-list">
      <div class="column-item">
        <span class="column-name">Timestamp</span>
        <span class="empty-cell"></span>
      </div>
      <div class="column-item">
        <span class="column-name">Description</span>
        <span class="empty-cell"></span>
      </div>
      <div class="column-item">
        <span class="column-name">Sample Type</span>
        <span class="empty-cell"></span>
      </div>
      <div class="column-item">
        <span class="column-name">Unit</span>
        <span class="empty-cell"></span>
      </div>
      <div class="column-item">
        <span class="column-name">Container</span>
        <span class="empty-cell"></span>
      </div>
      <div class="column-item">
        <span class="column-name">Mass Estimate</span>
        <span class="empty-cell"></span>
      </div>
    </div>
  </div>

  <script>
    const SPREADSHEET_ID = '1efR88nP511yGEPgjsR9KcT0nE2TQImzuxyYYZ6uUKGo';
    const API_KEY = 'AIzaSyAulwwKamF-YQhcJVBN5p1LbR99iItwZRI';
    const RANGE = 'Sheet1!A1:P';

    let sheetData = [];
    let count = 1;
    let lastTotalRows = 0; // Track previous total rows
    let lastRowIds = []; // Store unique row IDs (e.g. timestamp or name) for change detection

    function updateCountDisplay() {
      document.getElementById('pageCount').textContent = count;
    }

    function displayRow(idx) {
      if (!sheetData.length || idx >= sheetData.length) return;
      const row = sheetData[idx];
      const fields = [
        {selector: '.column-item:nth-child(1) .empty-cell', value: row[1] || ''},
        {selector: '.column-item:nth-child(2) .empty-cell', value: row[4] || ''},
        {selector: '.column-item:nth-child(3) .empty-cell', value: row[5] || ''},
        {selector: '.column-item:nth-child(4) .empty-cell', value: row[6] || ''},
        {selector: '.column-item:nth-child(5) .empty-cell', value: row[10] || ''},
        {selector: '.column-item:nth-child(6) .empty-cell', value: row[8] || ''},
      ];
      fields.forEach(f => {
        const el = document.querySelector(f.selector);
        if (el) {
          if (el.textContent !== f.value) {
            el.textContent = f.value;
            el.classList.add('flash-green');
            setTimeout(() => el.classList.remove('flash-green'), 500);
          } else {
            el.textContent = f.value;
          }
        }
      });
      document.querySelector('.static-header h1').textContent = row[0] || 'Sample Name';
      updateCountDisplay();
      updateEvaInfo(row, idx, getTotalDataRows());
    }

    function updateEvaInfo(row, idx, totalRows) {
      const eva = row[14] || '?';
      const station = row[15] || '?';
      const sampleNum = idx;
      const total = totalRows;
      const infoStr = `EVA ${eva} Station ${station} Sample# ${sampleNum} of ${total}`;
      document.getElementById('evaInfo').textContent = infoStr;
    }

    function addCount() {
      if (count < sheetData.length - 1) {
        count++;
        displayRow(count);
      }
    }

    function minusCount() {
      if (count > 1) {
        count--;
        displayRow(count);
      }
    }

    function getRowId(row) {
      // Use a unique identifier for a row, fallback to JSON string if needed
      // Prefer timestamp (col 1), or name (col 0), or full row string
      return (row[0] || '') + '|' + (row[1] || '');
    }

    function getTotalDataRows() {
      return sheetData.slice(1).filter(
        row => row && row.some(cell => cell && cell.trim() !== '')
      ).length;
    }

    function autoRefreshCurrentRow() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          const oldTotal = getTotalDataRows();
          sheetData = data.values || [];
          const newTotal = getTotalDataRows();
          if (newTotal > oldTotal) {
            count = sheetData.length - 1;
            displayRow(count);
          } else {
            if (count >= sheetData.length) count = sheetData.length - 1;
            displayRow(count);
          }
        })
        .catch(err => {
          console.error('Auto-refresh failed:', err);
        });
    }

    document.getElementById('forwardButton').addEventListener('click', addCount);
    document.getElementById('backButton').addEventListener('click', minusCount);

    async function fetchSheetData() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        sheetData = data.values || [];
        count = 1;
        lastTotalRows = getTotalDataRows();
        lastRowIds = sheetData.map(getRowId);
        displayRow(count);
        setInterval(() => {
          const prevRowIds = lastRowIds;
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
          fetch(url)
            .then(res => res.json())
            .then(data => {
              const oldTotal = lastTotalRows;
              const oldRowIds = prevRowIds;
              sheetData = data.values || [];
              const newTotal = getTotalDataRows();
              const newRowIds = sheetData.map(getRowId);

              // Find the index of the new row (first row in newRowIds not in oldRowIds)
              let newRowIdx = -1;
              for (let i = 0; i < newRowIds.length; i++) {
                if (!oldRowIds.includes(newRowIds[i]) && sheetData[i] && sheetData[i].some(cell => cell && cell.trim() !== '')) {
                  newRowIdx = i;
                  break;
                }
              }

              if (newRowIdx !== -1) {
                count = newRowIdx;
                displayRow(count);
              } else {
                if (count >= sheetData.length) count = sheetData.length - 1;
                displayRow(count);
              }

              lastTotalRows = newTotal;
              lastRowIds = newRowIds;
            })
            .catch(err => {
              console.error('Auto-refresh failed:', err);
            });
        }, 3500);
      } catch (err) {
        alert('Failed to fetch sheet data.');
        console.error(err);
      }
    }

    window.onload = fetchSheetData;
  </script>
</body>
</html>