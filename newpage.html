<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Data to Google Sheets</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* Base styles */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background-color: #f6f8fa; /* Light gray background like GitHub */
      color: #24292e; /* Dark text color */
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      margin: 0;
    }

    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      background-color: #ffffff; /* White background for the container */
      padding: 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
      max-width: 800px;
      width: 100%;
    }

    /* Section styles */
    .row-layout,
    .second-row-layout,
    .third-row-layout,
    .bottom-section,
    .last-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      border: 1px solid #d0d7de; /* Light border for separation */
      border-radius: 6px;
      background-color: #ffffff;
    }

    /* First Row Layout */
    .row-layout {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      width: 100%; /* Ensure it matches the container width */
      box-sizing: border-box; /* Include padding and border in the width calculation */
    }

    /* Label Box */
    .label-box {
      display: flex;
      flex-direction: row;
      background-color: #f6f8fa; /* Light gray background */
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 70%; /* Take up 70% of the container */
      font-size: 1.2em;
      font-weight: bold;
      color: #24292e;
      box-sizing: border-box; /* Include padding in the width calculation */
    }

    /* Button Group Box */
    .button-group-box {
      display: flex;
      gap: 10px;
      background-color: #ffffff; /* White background */
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      box-sizing: border-box; /* Include padding in the width calculation */
      width: 30%; /* Take up 30% of the container */
      justify-content: center; /* Center the buttons horizontally */
      align-items: center; /* Center the buttons vertically */
    }

    /* Buttons */
    .button {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      background-color: #2da44e; /* GitHub green */
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .button:hover {
      background-color: #218838; /* Darker green on hover */
    }

    .button.secondary {
      background-color: #f6f8fa; /* Light gray for secondary buttons */
      color: #24292e;
      border: 1px solid #d0d7de;
    }

    .button.secondary:hover {
      background-color: #eaeef2; /* Slightly darker gray on hover */
    }

    /* Labels */
    label {
      font-size: 14px;
      font-weight: 600;
      color: #57606a; /* Subtle gray for labels */
    }

    /* Inputs and Selects */
    input[type="text"],
    select {
      width: 100%;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #ffffff;
      color: #24292e;
      outline: none;
      transition: border-color 0.2s ease;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #0969da; /* GitHub blue for focus */
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3); /* Subtle blue outline */
    }

    /* Checkboxes */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2em; /* Make the text larger */
      font-weight: bold;
      color: #24292e;
    }

    .checkbox-label input {
      width: 24px; /* Make the checkbox larger */
      height: 24px;
      cursor: pointer;
    }

    /* Textarea */
    textarea {
      width: 100%;
      height: 100px;
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #ffffff;
      color: #24292e;
      resize: none;
      outline: none;
      transition: border-color 0.2s ease;
    }

    textarea:focus {
      border-color: #0969da;
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3);
    }

    /* Grid layout for bottom section */
    .grid-3col {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr)); /* 3 equal columns with flexible widths */
      gap: 16px; /* Add spacing between grid items */
      align-items: start; /* Align items to the top of their grid cells */
    }

    /* Section headers */
    .section-header {
      font-size: 18px;
      font-weight: bold;
      color: #24292e;
      margin-bottom: 8px;
    }

    /* Third Row Layout */
    .third-row-layout {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      border: 1px solid #d0d7de; /* Light border for separation */
      border-radius: 6px;
      background-color: #ffffff;
      box-sizing: border-box; /* Include padding and border in the width calculation */
    }

    .third-row-layout label {
      font-size: 18px;
      font-weight: bold;
      color: #000000; /* Subtle gray for labels */
    }

    /* Input Box */
    .third-row-layout input[type="text"] {
      width: 100%; /* Ensure it spans the full width of the section */
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #ffffff;
      color: #24292e;
      outline: none;
      box-sizing: border-box; /* Include padding and border in the width calculation */
      transition: border-color 0.2s ease;
    }

    .third-row-layout input[type="text"]:focus {
      border-color: #0969da; /* GitHub blue for focus */
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3); /* Subtle blue outline */
    }

    /* Second Row Layout */
    .second-row-layout {
      display: flex;
      flex-direction: row;
      justify-content: space-between; /* Space out the two boxes */
      align-items: center;
      padding: 16px;
      border: 1px solid #d0d7de; /* Light border for separation */
      border-radius: 6px;
      background-color: #ffffff;
      box-sizing: border-box;
    }

    /* Dropdown Group Box */
    .dropdown-group-box {
      display: flex;
      flex-direction: row; /* Keep dropdowns horizontal */
      gap: 20px; /* Add space between dropdowns */
      padding: 16px;
      background-color: #f6f8fa; /* Light gray background */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 48%; /* Match the width of the checkbox group box */
      box-sizing: border-box;
      justify-content: flex-start; /* Align dropdowns inside the box */
      align-items: center; /* Vertically center the dropdowns */
    }

    /* Dropdown Inputs */
    .dropdown-input select {
      width: 100%; /* Ensure dropdown spans the full width of its container */
      padding: 8px 12px; /* Reduce padding for a cleaner look */
      font-size: 20px; /* Match font size with other inputs */
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #ffffff;
      color: #24292e;
      outline: none;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    .dropdown-input select:focus {
      border-color: #0969da; /* GitHub blue for focus */
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3); /* Subtle blue outline */
    }

    /* Checkbox Group Box */
    .checkbox-group-box {
      display: flex;
      flex-direction: row; /* Keep checkboxes horizontal */
      gap: 20px; /* Add space between checkboxes */
      padding: 16px;
      background-color: #f6f8fa; /* Light gray background */
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 48%; /* Match the width of the dropdown group box */
      box-sizing: border-box;
      justify-content: flex-start; /* Align checkboxes inside the box */
      align-items: center; /* Vertically center the checkboxes */
    }

    /* Checkbox Labels */
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2em; /* Make the text larger */
      font-weight: bold;
      color: #24292e;
    }

    /* Checkboxes */
    .checkbox-label input {
      width: 28px; /* Make the checkbox larger */
      height: 28px;
      cursor: pointer;
    }
    /* Editable Name */
    .editable-name {
      font-size: 1.4em !important; /* Ensure the font size is applied */
      font-weight: bold; /* Make the text bold */
      color: #24292e; /* Default text color */
      border: none;
      background-color: transparent;
      outline: none;
      text-align: center;
      width: 200%;
      cursor: text;
      transition: color 0.2s ease, font-weight 0.2s ease;
    }

    .editable-name:focus {
      border-bottom: 2px solid #0969da; /* Subtle underline when editing */
    }

    /* Bold and Colored Name After Editing */
    .editable-name.saved {
      font-weight: bold;
      color: #0969da; /* GitHub blue */
    }

    /* Entry Number */
    .entry-number {
      visibility: hidden;
      font-size: 0.4em;
      color: #57606a; /* Subtle gray */
      margin-top: 4px;
    }
    .green-button {
      padding: 4px 10px;
      font-size: 16px;
      font-weight: bold;
      background-color: #2da44e; /* GitHub green */
      color: white;
      border: none;
      border-radius: 2%; /* Circular button */
      cursor: pointer;
      transition: background-color 0.2s ease;
      margin-left: 10px; /* Add spacing from the label */
    }

    .green-button:hover {
      background-color: #218838; /* Darker green on hover */
    }
    /* Footer */
    .footer {
      text-align: center;
      font-size: 12px; /* Small font size */
      color: #57606a; /* Subtle gray color */
      margin-top: 20px; /* Add spacing from the content above */
      padding: 10px 0;
      border-top: 1px solid #d0d7de; /* Subtle top border for separation */
    } 

    /* Bottom Section */
    .bottom-section {
      display: flex;
      flex-direction: column; /* Stack the content vertically */
      gap: 16px; /* Add spacing between rows */
      padding: 16px; /* Consistent padding */
      border: 1px solid #d0d7de; /* Light border for separation */
      border-radius: 6px; /* Rounded corners */
      background-color: #ffffff; /* White background */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
      box-sizing: border-box; /* Include padding and border in the width calculation */
    }

    /* Grid Layout for Sample Characteristics */
    .grid-3col {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr)); /* 3 equal columns with flexible widths */
      gap: 20px; /* Add spacing between grid items */
      align-items: start; /* Align items to the top of their grid cells */
    }

    /* Labels in the Bottom Section */
    .bottom-section label {
      font-size: 14px;
      font-weight: 600;
      color: #57606a; /* Subtle gray for labels */
      margin-bottom: 4px; /* Add spacing below labels */
    }

    /* Inputs and Dropdowns in the Bottom Section */
    .bottom-section input[type="text"],
    .bottom-section select {
      width: 65%; /* Ensure inputs span the full width of their container */
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #ffffff;
      color: #24292e;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .bottom-section input[type="text"]:focus,
    .bottom-section select:focus {
      border-color: #0969da; /* GitHub blue for focus */
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3); /* Subtle blue outline */
    }

    /* Last Section */
    .last-section {
      display: flex;
      flex-direction: column; /* Stack the content vertically */
      gap: 16px; /* Add spacing between rows */
      padding: 16px; /* Consistent padding */
      border: 1px solid #d0d7de; /* Light border for separation */
      border-radius: 6px; /* Rounded corners */
      background-color: #ffffff; /* White background */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
      box-sizing: border-box; /* Include padding and border in the width calculation */
    }

    /* Layout for individual rows in the last section */
    .last-section-layout {
      display: flex;
      flex-direction: column; /* Stack label and input vertically */
      gap: 8px; /* Add spacing between label and input */
    }

    /* Inputs in the Last Section */
    .last-section input[type="text"] {
      width: 95% !important; /* Ensure inputs span the full width of their container */
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #ffffff;
      color: #24292e;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .last-section input[type="text"]:focus {
      border-color: #0969da; /* GitHub blue for focus */
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3); /* Subtle blue outline */
    }
  </style>
</head>
<body>
    <div class="container">
        <!-- Button row, this should be a back and next arrow -->
        <div class="row-layout">
          <!-- Label Box -->
          <div class="label-box">
            <input id="editableName" class="editable-name" type="text" placeholder="Enter Sample Name...." />
            <div id="entryNumber" class="entry-number">Entry #0</div>
            <button id="addRowButton" class="button green-button">+</button>
          </div>

          <!-- Start/End Time Buttons Box -->
          <div class="button-group-box">
            <button class="button">Start Time</button>
            <button class="button">End Time</button>
          </div>

          <!-- Back/Next Buttons Box -->
          <div class="button-group-box">
            <button class="button">&#8592; Back</button>
            <button class="button">Next &#8594;</button>
          </div>
        </div>

        <div class="second-row-layout">
          <!-- Dropdown Group Box -->
          <div class="dropdown-group-box">
            <label class="dropdown-input">
              <select id="Station" name="Station:">
                <option value="" disabled selected>Station...</option>
                <option value="Location 1">Location 1</option>
                <option value="Location 2">Location 2</option>
                <option value="Location 3">Location 3</option>
                <option value="Location 4">Location 4</option>
              </select>
            </label>
            <label class="dropdown-input">
              <select id="EVAnumber" name="EVA Number:">
                <option value="" disabled selected>EVA...</option>
                <option value="Location A">A</option>
                <option value="Location B">B</option>
                <option value="Location C">C</option>
                <option value="Location D">D</option>
              </select>
            </label>
          </div>
        
          <!-- Checkbox Group Box -->
          <div class="checkbox-group-box">
            <label class="checkbox-label">
              <input type="checkbox" id="Planned" name="Planned" value="True">
              Planned
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="Unplanned" name="Unplanned" value="True">
              Unplanned
            </label>
          </div>
        </div>

        <div class="third-row-layout">
            <label for="CrewDescription">Crew Description:</label><br>
            <input type="text" id="CrewDescription" name="Crew Description">
        </div>
        <div class="bottom-section">
          <div class="section-header">Sample Characteristics</div>
          <div class="grid-3col">
            <!-- Row 1: Labels -->
            <label for="SampleType">Sample Type:</label>
            <label for="Units">Units:</label>
            <label for="Condition">Condition:</label>
        
            <!-- Row 2: Inputs -->
            <select id="SampleType" name="Sample Type:">
              <option value=""></option>
              <option value="Rake">Rake</option>
              <option value="Scoop">Scoop</option>
              <option value="Chip">Chip</option>
              <option value="Float">Float</option>
              <option value="Skim">Skim</option>
              <option value="Single Drive Tube">Single Drive Tube</option>
              <option value="Double Drive Tube">Double Drive Tube</option>
            </select>
        
            <input type="text" id="Units" name="Unit:">
        
            <select id="Condition" name="Condition:">
              <option value=""></option>
              <option value="Illuminated">Illuminated</option>
              <option value="Shadowed">Shadowed</option>
              <option value="Undisturbed">Undisturbed</option>
              <option value="Disturbed">Disturbed</option>
              <option value="Cold">Cold</option>
            </select>
        
            <!-- Row 3: Labels -->
            <label for="MassEstimate">Mass Estimate:</label>
            <label for="VolumeEstimate">Volume Estimate:</label>
            <label for="ContainerNumber">Container Number(s):</label>
        
            <!-- Row 4: Inputs -->
            <input type="text" id="MassEstimate" name="Mass Estimate:">
            <input type="text" id="VolumeEstimate" name="Volume Estimate:">
            <input type="text" id="ContainerNumber" name="Container Number(s)">
          </div>
        </div>
        <div class="last-section">
          <div class="section-header">Collection Details</div>
          <div class="last-section-layout">
            <label for="ContaminationNotes">Contamination Notes:</label>
            <input type="text" id="ContaminationNotes" name="Contamination Notes">
          </div>
          <div class="last-section-layout">
            <label for="SamplingTools">Sampling Tool(s):</label>
            <input type="text" id="SamplingTools" name="Sampling Tool(s)">
          </div>
        </div>
        <div class="footer" id="footerCount">1</div>
        
    </div>

    <script>
      //Function to write Start Time to Sheet with safeApiCall checks
      function writeStartTime(currentCount) {
        return safeApiCall(() => {
            const nowGMT = new Date().toISOString();
            const targetRow = currentCount + 1;
            const rangeToCheck = `Sheet1!B${targetRow}`;

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
                .then(res => {
                    if (!res.ok) throw res;
                    return res.json();
                })
                .then(data => {
                    const existingRow = data.values?.[0] || [];
                    let rangeToWrite;
                    let values;

                    if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                        rangeToWrite = `Sheet1!B${targetRow}:C${targetRow}`; // Write to columns B and C
                        values = [[nowGMT, nowGMT]]; // Write the timestamp to both columns
                    } else {
                        rangeToWrite = `Sheet1!C${targetRow}`; // Write to column C only
                        values = [[nowGMT]]; // Write the timestamp to column C
                    }

                    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ values })
                    });
                });
        });
      }
      //Function to write End Time to Sheet with safeApiCall checks
      function writeEndTime(currentCount) {
        return safeApiCall(() => {
            const nowGMT = new Date().toISOString();
            const targetRow = currentCount + 1;
            const rangeToCheck = `Sheet1!B${targetRow}`; // Check column B

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
                .then(res => {
                    if (!res.ok) throw res;
                    return res.json();
                })
                .then(data => {
                    const existingRow = data.values?.[0] || [];
                    let rangeToWrite;
                    let values;

                    if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                        rangeToWrite = `Sheet1!B${targetRow}:D${targetRow}`; // Write to columns B and D
                        values = [[nowGMT, existingRow[2] || "", nowGMT]]; // Write the timestamp to B and D, preserve C
                    } else {
                        rangeToWrite = `Sheet1!D${targetRow}`; // Write to column D only
                        values = [[nowGMT]]; // Write the timestamp to column D
                    }

                    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ values })
                    });
                });
        });
      }
      //function for writing Crew Description to Sheet with safeApiCall checks
      function writeCrewDescriptionToSheet(crewDescription, currentCount) {
        return safeApiCall(() => {
            const targetRow = currentCount + 1;
            const nowGMT = new Date().toISOString();
            const rangeToCheck = `Sheet1!B${targetRow}`; // Check column B

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
                .then(res => {
                    if (!res.ok) throw res;
                    return res.json();
                })
                .then(data => {
                    const existingRow = data.values?.[0] || [];
                    let rangeToWrite;
                    let values;

                    if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                        rangeToWrite = `Sheet1!B${targetRow}:E${targetRow}`; // Write to columns B and E
                        values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", crewDescription]]; // Write timestamp to B, preserve C and D, and description to E
                    } else {
                        rangeToWrite = `Sheet1!E${targetRow}`; // Write to column E only
                        values = [[crewDescription]]; // Write the description to column E
                    }

                    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ values })
                    });
                });
        });
      }
      // function for writing sampling tools to sheet with safeApiCall checks
      function writeToolsToSheet(selectedTools, currentCount) {
        return safeApiCall(() => {
            const targetRow = currentCount + 1;
            const nowGMT = new Date().toISOString();
            const rangeToCheck = `Sheet1!B${targetRow}`; // Check column B

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
                .then(res => {
                    if (!res.ok) throw res;
                    return res.json();
                })
                .then(data => {
                    const existingRow = data.values?.[0] || [];
                    let rangeToWrite;
                    let values;

                    if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                        rangeToWrite = `Sheet1!B${targetRow}:M${targetRow}`; // Write to columns B and M
                        values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", existingRow[7] || "", existingRow[8] || "", existingRow[9] || "", existingRow[10] || "", existingRow[11] || "", existingRow[12] || "", selectedTools]]; // Write timestamp to B, preserve C-L, and tools to M
                    } else {
                        rangeToWrite = `Sheet1!M${targetRow}`; // Write to column M only
                        values = [[selectedTools]]; // Write the tools to column M
                    }

                    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ values })
                    });
                });
        });
      }
      // function for writing Sample Type to sheet with safeApiCall checks
      function writeSampleTypeToSheet(selectedSampleType, currentCount) {
        return safeApiCall(() => {
            const targetRow = currentCount + 1;
            const nowGMT = new Date().toISOString();
            const rangeToCheck = `Sheet1!B${targetRow}`;

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
                .then(res => {
                    if (!res.ok) throw res;
                    return res.json();
                })
                .then(data => {
                    const existingRow = data.values?.[0] || [];
                    let rangeToWrite;
                    let values;

                    if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                        rangeToWrite = `Sheet1!B${targetRow}:F${targetRow}`; // Write to columns B and F
                        values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", selectedSampleType]]; // Write timestamp to B, preserve C-E, and sample type to F
                    } else {
                        rangeToWrite = `Sheet1!F${targetRow}`; // Write to column F only
                        values = [[selectedSampleType]]; // Write the sample type to column F
                    }

                    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                        method: "PUT",
                        headers: {
                            "Authorization": `Bearer ${accessToken}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ values })
                    });
                });
        });
      }
      //function for integfrating timeout on page load
      function fetchWithTimeoutAndPrompt(rowIndex, timeoutMs = 10000) {
        let didRespond = false;

        // Start the fetch
        fetchRowData(rowIndex).then(data => {
          didRespond = true;
          fillInputsWithRowData(data);
        }).catch(err => {
          didRespond = true;
          console.error("Fetch error:", err);
          // Optionally show an error to the user here
        });

        // Set up the timeout to prompt sign-in if no response
        setTimeout(() => {
          if (!didRespond) {
            alert("Session expired or not signed in. Please sign in with Google to continue.");
            if (typeof tokenClient !== "undefined" && tokenClient) {
              tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
              window.location.href = 'index.html'; // Fallback: redirect to login
            }
          }
        }, timeoutMs);
      }
      // function for writing Contamination Notes:
      function writeContaminationToSheet(selectedContamination, currentCount) {
        return safeApiCall(() => {
            const targetRow = currentCount + 1;
            const nowGMT = new Date().toISOString();
            const rangeToCheck = `Sheet1!B${targetRow}`; // Check column B

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                const existingRow = data.values?.[0] || [];
                let rangeToWrite;
                let values;

                if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                    rangeToWrite = `Sheet1!B${targetRow}:L${targetRow}`; // Write to columns B and L
                    values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", existingRow[7] || "", existingRow[8] || "", existingRow[9] || "", existingRow[10] || "", existingRow[11] || "", selectedContamination]]; // Write timestamp to B, preserve C-K, and contamination to L
                } else {
                    rangeToWrite = `Sheet1!L${targetRow}`; // Write to column L only
                    values = [[selectedContamination]]; // Write the contamination to column L
                }

                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values })
                });
            })
            .catch(error => {
                console.error("Failed to write Contamination Notes:", error);
            });
        });
      }
      //function for writing Container Number(s) to sheet
      function writeContainerToSheet(selectedContainer, currentCount) {
        return safeApiCall(() => {
            const targetRow = currentCount + 1;
            const nowGMT = new Date().toISOString();
            const rangeToCheck = `Sheet1!B${targetRow}`; // Check column B

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                const existingRow = data.values?.[0] || [];
                let rangeToWrite;
                let values;

                if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                    rangeToWrite = `Sheet1!B${targetRow}:K${targetRow}`; // Write to columns B and K
                    values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", existingRow[7] || "", existingRow[8] || "", existingRow[9] || "", existingRow[10] || "", selectedContainer]]; // Write timestamp to B, preserve C-J, and container to K
                } else {
                    rangeToWrite = `Sheet1!K${targetRow}`; // Write to column K only
                    values = [[selectedContainer]]; // Write the container to column K
                }

                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values })
                });
            })
            .catch(error => {
                console.error("Failed to write Container Number(s):", error);
            });
        });
      }
      //function for writing Volume Estimate
      function writeVolumeToSheet(selectedVolume, currentCount) {
        return safeApiCall(() => {
          const targetRow = currentCount + 1;
          const nowGMT = new Date().toISOString();
          const rangeToCheck = `Sheet1!B${targetRow}`;

          return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                const existingRow = data.values?.[0] || [];
                let rangeToWrite;
                let values;

                if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                    rangeToWrite = `Sheet1!B${targetRow}:J${targetRow}`; // Write to columns B and J
                    values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", existingRow[7] || "", selectedVolume]]; // Write timestamp to B, preserve C-I, and volume to J
                } else {
                    rangeToWrite = `Sheet1!J${targetRow}`; // Write to column J only
                    values = [[selectedVolume]]; // Write the volume to column J
                }

                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values })
                });
            })
            .catch(error => {
                console.error("Failed to write Volume Estimate:", error);
            });
        });
      };

      // function for writing Mass Estimate
      function writeMassToSheet(selectedMass, currentCount) {
        return safeApiCall(() => {
          const targetRow = currentCount + 1;
          const nowGMT = new Date().toISOString();
          const rangeToCheck = `Sheet1!B${targetRow}`;

          return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                const existingRow = data.values?.[0] || [];
                let rangeToWrite;
                let values;

                if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                    rangeToWrite = `Sheet1!B${targetRow}:I${targetRow}`; // Write to columns B and I
                    values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", existingRow[7] || "", existingRow[8] || "", selectedMass]]; // Write timestamp to B, preserve C-H, and mass to I
                } else {
                    rangeToWrite = `Sheet1!I${targetRow}`; // Write to column I only
                    values = [[selectedMass]]; // Write the mass to column I
                }

                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values })
                });
            })
            .catch(error => {
                console.error("Failed to write Mass Estimate:", error);
            });
        });
      };

      //function for writing Condition
      function writeConditionToSheet(selectedCondition, currentCount) {
        return safeApiCall(() => {
          const targetRow = currentCount + 1;
          const nowGMT = new Date().toISOString();
          const rangeToCheck = `Sheet1!B${targetRow}`;

          return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                const existingRow = data.values?.[0] || [];
                let rangeToWrite;
                let values;

                if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                    rangeToWrite = `Sheet1!B${targetRow}:H${targetRow}`; // Write to columns B and H
                    values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", existingRow[7] || "", selectedCondition]]; // Write timestamp to B, preserve C-G, and condition to H
                } else {
                    rangeToWrite = `Sheet1!H${targetRow}`; // Write to column H only
                    values = [[selectedCondition]]; // Write the condition to column H
                }

                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values })
                });
            })
            .catch(error => {
                console.error("Failed to write Condition:", error);
            });
        });
      };

      //function for writing checkbox entry
      function writeCheckboxToSheet(labelText, currentCount) {
        return safeApiCall(() => {
            const targetRow = currentCount + 1;
            const nowGMT = new Date().toISOString();
            const rangeToCheck = `Sheet1!B${targetRow}`;

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                const existingRow = data.values?.[0] || [];
                let rangeToWrite;
                let values;

                if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                    rangeToWrite = `Sheet1!B${targetRow}:N${targetRow}`; // Write to columns B and N
                    values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", existingRow[7] || "", existingRow[8] || "", existingRow[9] || "", existingRow[10] || "", existingRow[11] || "", existingRow[12] || "", labelText]]; // Write timestamp to B, preserve C-M, and checkbox to N
                } else {
                    rangeToWrite = `Sheet1!N${targetRow}`; // Write to column N only
                    values = [[labelText]]; // Write the checkbox to column N
                }

                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values })
                });
            })
            .catch(error => {
                console.error("Failed to write Checkbox:", error);
            });
        });
      }

      //function for writing units to sheet
      function writeUnitsToSheet(selectedUnits, currentCount) {
        return safeApiCall(() => {
          const targetRow = currentCount + 1;
          const nowGMT = new Date().toISOString();
          const rangeToCheck = `Sheet1!B${targetRow}`;

          return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToCheck}?majorDimension=ROWS`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                }
            })
            .then(res => {
                if (!res.ok) throw res;
                return res.json();
            })
            .then(data => {
                const existingRow = data.values?.[0] || [];
                let rangeToWrite;
                let values;

                if (existingRow.length === 0 || existingRow[0] === undefined || existingRow[0] === "") { // Check if column B is empty
                    rangeToWrite = `Sheet1!B${targetRow}:G${targetRow}`; // Write to columns B and G
                    values = [[nowGMT, existingRow[2] || "", existingRow[3] || "", existingRow[4] || "", existingRow[5] || "", existingRow[6] || "", selectedUnits]]; // Write timestamp to B, preserve C-F, and units to G
                } else {
                    rangeToWrite = `Sheet1!G${targetRow}`; // Write to column G only
                    values = [[selectedUnits]]; // Write the units to column G
                }

                return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${rangeToWrite}?valueInputOption=RAW`, {
                    method: "PUT",
                    headers: {
                        "Authorization": `Bearer ${accessToken}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ values })
                });
            })
            .catch(error => {
                console.error("Failed to write Units:", error);
            });
        });
      };
      
      // Function to fetch the pre-filled name for the current row
      function fetchNameForRow(rowIndex) {
      const range = `Sheet1!A${rowIndex + 2}:A${rowIndex + 2}`; // Adjusted to use rowIndex + 2 to account for headers

      return safeApiCall(() => {
        return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?majorDimension=ROWS`, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
          },
        })
          .then((response) => {
            if (!response.ok) throw response;
            return response.json();
          })
          .then((data) => {
            const editableName = document.getElementById("editableName");
            const name = data.values?.[0]?.[0] || "Sample Name";

            if (editableName) {
              editableName.value = name;

              // Apply gray color if the placeholder is used
              if (name === "Sample Name") {
                editableName.style.color = "#b5b7b9"; // Gray color
              } else {
                editableName.style.color = "#24292e"; // Default text color
              }
            }

            return name;
          })
          .catch((error) => {
            console.error("Failed to fetch name:", error);
            return "Sample Name"; // Default name on error
          });
      });
    }

      function fetchRowData(rowIndex) {
        const range = `Sheet1!A${rowIndex + 2}:N${rowIndex + 2}`; // Adjust N to your last column
        return safeApiCall(() => {
          return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?majorDimension=ROWS`, {
            method: "GET",
            headers: {
              "Authorization": `Bearer ${accessToken}`,
            }
          })
            .then(res => {
              if (!res.ok) throw res;
              return res.json();
            })
            .then(data => data.values?.[0] || []);
        });
      }

      function fillInputsWithRowData(rowData) {
        // Editable Name (A)
        const editableName = document.getElementById("editableName");
        if (editableName) {
          const value = rowData[0] || "";
          editableName.value = value;
          editableName.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          editableName.readOnly = true;
          editableName.addEventListener("focus", function handler() {
            editableName.style.color = "#24292e";
            editableName.readOnly = false;
            if (editableName.value === "Sample Name") editableName.value = "";
            editableName.removeEventListener("focus", handler);
          });
        }

        // Crew Description (E)
        const crewDescription = document.getElementById("CrewDescription");
        if (crewDescription) {
          const value = rowData[4] || "";
          crewDescription.value = value.trim() ? value : "Describe the sample...";
          crewDescription.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          crewDescription.readOnly = true;
          crewDescription.addEventListener("focus", function handler() {
            crewDescription.style.color = "#24292e";
            crewDescription.readOnly = false;
            if (crewDescription.value === "Describe the sample...") crewDescription.value = "";
            crewDescription.removeEventListener("focus", handler);
          });
        }

        // Units (G)
        const units = document.getElementById("Units");
        if (units) {
          const value = rowData[6] || "";
          units.value = value.trim() ? value : "Units (e.g. g, kg, mL)";
          units.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          units.readOnly = true;
          units.addEventListener("focus", function handler() {
            units.style.color = "#24292e";
            units.readOnly = false;
            if (units.value === "Units (e.g. g, kg, mL)") units.value = "";
            units.removeEventListener("focus", handler);
          });
        }

        // Mass Estimate (I)
        const massEstimate = document.getElementById("MassEstimate");
        if (massEstimate) {
          const value = rowData[8] || "";
          massEstimate.value = value.trim() ? value : "Estimated mass";
          massEstimate.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          massEstimate.readOnly = true;
          massEstimate.addEventListener("focus", function handler() {
            massEstimate.style.color = "#24292e";
            massEstimate.readOnly = false;
            if (massEstimate.value === "Estimated mass") massEstimate.value = "";
            massEstimate.removeEventListener("focus", handler);
          });
        }

        // Volume Estimate (J)
        const volumeEstimate = document.getElementById("VolumeEstimate");
        if (volumeEstimate) {
          const value = rowData[9] || "";
          volumeEstimate.value = value.trim() ? value : "Estimated volume";
          volumeEstimate.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          volumeEstimate.readOnly = true;
          volumeEstimate.addEventListener("focus", function handler() {
            volumeEstimate.style.color = "#24292e";
            volumeEstimate.readOnly = false;
            if (volumeEstimate.value === "Estimated volume") volumeEstimate.value = "";
            volumeEstimate.removeEventListener("focus", handler);
          });
        }

        // Container Number (K)
        const containerNumber = document.getElementById("ContainerNumber");
        if (containerNumber) {
          const value = rowData[10] || "";
          containerNumber.value = value.trim() ? value : "Container #";
          containerNumber.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          containerNumber.readOnly = true;
          containerNumber.addEventListener("focus", function handler() {
            containerNumber.style.color = "#24292e";
            containerNumber.readOnly = false;
            if (containerNumber.value === "Container #") containerNumber.value = "";
            containerNumber.removeEventListener("focus", handler);
          });
        }

        // Contamination Notes (L)
        const contaminationNotes = document.getElementById("ContaminationNotes");
        if (contaminationNotes) {
          const value = rowData[11] || "";
          contaminationNotes.value = value.trim() ? value : "Contamination notes";
          contaminationNotes.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          contaminationNotes.readOnly = true;
          contaminationNotes.addEventListener("focus", function handler() {
            contaminationNotes.style.color = "#24292e";
            contaminationNotes.readOnly = false;
            if (contaminationNotes.value === "Contamination notes") contaminationNotes.value = "";
            contaminationNotes.removeEventListener("focus", handler);
          });
        }

        // Sampling Tools (M)
        const samplingTools = document.getElementById("SamplingTools");
        if (samplingTools) {
          const value = rowData[12] || "";
          samplingTools.value = value.trim() ? value : "Sampling tool(s)";
          samplingTools.style.color = value.trim() ? "#24292e" : "#b5b7b9";
          samplingTools.readOnly = true;
          samplingTools.addEventListener("focus", function handler() {
            samplingTools.style.color = "#24292e";
            samplingTools.readOnly = false;
            if (samplingTools.value === "Sampling tool(s)") samplingTools.value = "";
            samplingTools.removeEventListener("focus", handler);
          });
        }

        // Dropdowns
        const sampleType = document.getElementById("SampleType");
        if (sampleType) {
          sampleType.value = rowData[5] || "";
        }
        const condition = document.getElementById("Condition");
        if (condition) {
          condition.value = rowData[7] || "";
        }
        const station = document.getElementById("Station");
        if (station) {
          station.value = rowData[14] || "";
        }
        const evaNumber = document.getElementById("EVAnumber");
        if (evaNumber) {
          evaNumber.value = rowData[15] || "";
        }

        // Checkboxes
        const planned = document.getElementById("Planned");
        const unplanned = document.getElementById("Unplanned");
        if (planned) planned.checked = rowData[13] === "Planned";
        if (unplanned) unplanned.checked = rowData[13] === "Unplanned";

        // Update the entry number label
        const entryNumber = document.getElementById("entryNumber");
        if (entryNumber) {
          entryNumber.innerText = `Entry #${count}`;
        }
      }

      let tokenClient;
      const CLIENT_ID = '263288053429-39j61v5mij7mhrtqg9peqov1i33nedc6.apps.googleusercontent.com';
      const SPREADSHEET_ID = '1efR88nP511yGEPgjsR9KcT0nE2TQImzuxyYYZ6uUKGo';
      let accessToken = localStorage.getItem('accessToken');
      let count = 1;

      // arbitrary variables to hold the values of the checkboxes
      const checkbox1 = document.getElementById('Planned');
      const checkbox2 = document.getElementById('Unplanned');

      // Add event listeners to the checkboxes to ensure only one can be checked at a time
      checkbox1.addEventListener('change', () => { if (checkbox1.checked) checkbox2.checked = false; });
      checkbox2.addEventListener('change', () => { if (checkbox2.checked) checkbox1.checked = false; });

      // Function to initialize the token client
      // This function is called when the page loads to set up the token client.
      function initTokenClient() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/spreadsheets',
          callback: (tokenResponse) => {
            if (tokenResponse.access_token) {
              accessToken = tokenResponse.access_token;
              localStorage.setItem('accessToken', accessToken);
              console.log("Access token refreshed.");
            } else {
              console.error("Failed to refresh access token.");
            }
          }
        });
      }
  
      // Function to refresh the access token
      // This function is called when the access token is expired or invalid.
      function refreshAccessToken(callback) {
        if (!tokenClient) {
          alert("Session expired. Please sign in again.");
          window.location.href = 'index.html'; // Redirect to your login page
          return;
        }

        tokenClient.callback = (tokenResponse) => {
          if (tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            localStorage.setItem('accessToken', accessToken);
            console.log("Token refreshed.");
            if (callback) callback();
          } else {
            alert("Session expired. Please sign in again.");
            localStorage.removeItem('accessToken');
            window.location.href = 'index.html'; // Redirect to your login page
          }
        };

        tokenClient.requestAccessToken({ prompt: '' });
      }
      
      // Function to handle API calls safely
      // This function checks if the access token is available and valid before making API calls.
      function safeApiCall(apiFunction) {
      if (!accessToken) {
        console.warn("No access token. Attempting to sign in...");
        return new Promise((resolve, reject) => {
          tokenClient.callback = (tokenResponse) => {
            if (tokenResponse.access_token) {
              accessToken = tokenResponse.access_token;
              localStorage.setItem('accessToken', accessToken);
              console.log("Access token obtained.");
              apiFunction().then(resolve).catch(reject); // Retry the API call
            } else {
              alert("Sign-in required. Please sign in to continue.");
              reject("No access token");
            }
          };
          tokenClient.requestAccessToken({ prompt: 'consent' }); // Bring up the GIS sign-in window
        });
      }

      return apiFunction().catch(err => {
        if (err?.status === 401 || err?.message?.includes('401')) {
          console.warn("Access token expired. Attempting refresh...");
          return new Promise((resolve, reject) => {
            refreshAccessToken(() => {
              apiFunction().then(resolve).catch(reject); // Retry the API call
            });
          });
        } else {
          console.error("API error:", err);
          throw err; // Re-throw the error for further handling
        }
      });
    }

      // Function to update the label and footer count
      function updateLabel() {
        const entryNumber = document.getElementById("entryNumber");
        const footerCount = document.getElementById("footerCount");

        if (entryNumber) {
          entryNumber.innerText = `Entry #${count}`;
          console.log("Label updated to:", entryNumber.innerText); // Debugging log
        } else {
          console.error("Entry number element not found.");
        }

        if (footerCount) {
          footerCount.innerText = `${count}`;
          console.log("Footer updated to:", footerCount.innerText); // Debugging log
        } else {
          console.error("Footer element not found.");
        }
      }
      // Function to clear all input fields
      function clearFields() {
        document.querySelectorAll('input[type="text"]').forEach(input => input.value = "");
        document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
      }

      // Start Time Button Logic
      const startButton = document.querySelectorAll(".button-group-box .button")[0]; // First button in the first button-group-box
      startButton.addEventListener("click", () => {
        safeApiCall(() => writeStartTime(count));
      });

      // End Time Button Logic
      const endButton = document.querySelectorAll(".button-group-box .button")[1]; // Second button in the first button-group-box
      endButton.addEventListener("click", () => {
        safeApiCall(() => writeEndTime(count));
      });

      function insertRowBelow(targetRowIndex) {
        return safeApiCall(() => {
            const sheetId = 0; // Usually 0 for the first sheet
            const insertRowIndex = targetRowIndex + 1;

            const requestBody = {
                requests: [
                    {
                        insertDimension: {
                            range: {
                                sheetId: sheetId,
                                dimension: "ROWS",
                                startIndex: insertRowIndex,
                                endIndex: insertRowIndex + 1,
                            },
                            inheritFromBefore: true,
                        },
                    },
                ],
            };

            return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}:batchUpdate`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${accessToken}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(requestBody),
            })
                .then((response) => {
                    if (!response.ok) throw response;
                    return response.json();
                })
                .then((data) => {
                    console.log("Row inserted successfully:", data);

                    // Increment count to reflect the new row
                    count++;
                    localStorage.setItem('count', count);
                    console.log("Count updated to:", count);

                    // Update the label to reflect the new entry
                    updateLabel();

                    // Only now: clear and fetch for the new row
                    clearFields();

                    // Set editableName to "Enter Sample Name" in grey and as placeholderer
                    const editableName = document.getElementById("editableName");
                    if (editableName) {
                        editableName.value = "Enter Sample Name";
                        editableName.placeholder = "Enter Sample Name";
                        editableName.style.color = "#b5b7b9";
                        editableName.readOnly = false;
                        editableName.focus();
                        editableName.addEventListener("focus", function handler() {
                            if (editableName.value === "Enter Sample Name") editableName.value = "";
                            editableName.style.color = "#24292e";
                            editableName.readOnly = false;
                            editableName.removeEventListener("focus", handler);
                        });
                    }

                    fetchWithTimeoutAndPrompt(count - 1);
                })
                .catch((error) => {
                    console.error("Failed to insert row:", error);
                });
        });
    }

      // Function to write the updated name to the spreadsheet
      function writeNameToSheet(rowIndex, name) {
        const range = `Sheet1!A${rowIndex + 2}:A${rowIndex + 2}`; // Adjusted to use rowIndex + 2 to account for headers
        const values = [[name]];

        return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=RAW`, {
          method: "PUT",
          headers: {
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ values }),
        })
          .then((response) => {
            if (!response.ok) throw response;
            return response.json();
          })
          .then((data) => {
            console.log("Name updated successfully:", data);
          })
          .catch((error) => {
            console.error("Failed to update name:", error);
          });
      }

      // Initialize the editable name and entry number
      function initializeNameAndEntry() {
        const editableName = document.getElementById("editableName");
        const entryNumber = document.getElementById("entryNumber");

        // Fetch and display the name for the current row
        fetchNameForRow(count - 1).then((name) => {
          editableName.value = name;

          // Apply gray color if the placeholder is used
          if (name === "Sample Name") {
            editableName.style.color = "#8e9296"; // Gray color for placeholder
          } else {
            editableName.style.color = "#24292e"; // Default text color
          }
        });

        // Update the entry number
        entryNumber.innerText = `Entry #${count}`;

        // Add event listener for editing the name
        editableName.addEventListener("keydown", (event) => {
          if (event.key === "Enter" || event.keyCode === 13) {
            const updatedName = editableName.value.trim();
            if (updatedName) {
              writeNameToSheet(count - 1, updatedName).then(() => {
                // Apply the "saved" style
                editableName.classList.add("saved");
                editableName.style.color = "#0969da"; // Set color to blue when saved
                setTimeout(() => {
                  editableName.classList.remove("saved");
                  editableName.style.color = "#24292e"; // Reset to default text color
                }, 2000); // Remove the style after 2 seconds
              });
            }
          }
        });
      }

      function handleInputEvent(event, apiFunction) {
        const key = event.key || event.keyCode || event.which;

        // Check for Enter key (keyCode 13)
        if (key === "Enter" || key === 13) {
            const value = event.target.value.trim();
            if (value) {
                safeApiCall(() => apiFunction(value, count)) // Pass count here
                    .then(() => {
                        console.log(`${event.target.id} written successfully.`);
                        // Do NOT clear the input field; instead, set color to black
                        event.target.style.color = "#24292e";
                    })
                    .catch(err => {
                        console.error(`Failed to write ${event.target.id}:`, err);
                    });
            }
        }
      }

      function handleDropdownChange(event, apiFunction) {
        const value = event.target.value;
        if (value) {
            safeApiCall(() => apiFunction(value, count))
                .then(() => {
                    console.log(`${event.target.id} written successfully.`);
                })
                .catch(err => {
                    console.error(`Failed to write ${event.target.id}:`, err);
                });
            }
        }
  
      window.onload = () => {
        if (!localStorage.getItem('accessToken')) {
          alert("Session expired. Please sign in again.");
          window.location.href = 'index.html';
          return;
        }

        initTokenClient();

        count = parseInt(localStorage.getItem('count')) || 1;
        updateLabel();
        initializeNameAndEntry();
        fetchWithTimeoutAndPrompt(count - 1);

        // Attach event listeners to all text inputs
        document.querySelectorAll('input[type="text"]').forEach(input => {
            input.addEventListener("keydown", event => {
                switch (input.id) {
                    case "CrewDescription":
                        handleInputEvent(event, (value) => writeCrewDescriptionToSheet(value, count));
                        break;
                    case "Units":
                        handleInputEvent(event, (value) => writeUnitsToSheet(value, count));
                        break;
                    case "MassEstimate":
                        handleInputEvent(event, (value) => writeMassToSheet(value, count));
                        break;
                    case "VolumeEstimate":
                        handleInputEvent(event, (value) => writeVolumeToSheet(value, count));
                        break;
                    case "ContainerNumber":
                        handleInputEvent(event, (value) => writeContainerToSheet(value, count));
                        break;
                    case "ContaminationNotes":
                        handleInputEvent(event, (value) => writeContaminationToSheet(value, count));
                        break;
                    case "SamplingTools":
                        handleInputEvent(event, (value) => writeToolsToSheet(value, count));
                        break;
                    default:
                        console.warn(`No handler defined for input: ${input.id}`);
                }
            });
        });

        // Attach event listener to the plus button
        const addRowButton = document.getElementById("addRowButton");
        addRowButton.addEventListener("click", () => {
          console.log("Plus button clicked"); // Debugging log
          insertRowBelow(count); // Pass the current row index
        });

        // Attach event listeners to all dropdowns
        document.querySelectorAll('select').forEach(select => {
            select.addEventListener("change", event => {
                switch (select.id) {
                    case "SampleType":
                        handleDropdownChange(event, (value) => writeSampleTypeToSheet(value, count));
                        break;
                    case "Condition":
                        handleDropdownChange(event, (value) => writeConditionToSheet(value, count));
                        break;
                    default:
                        console.warn(`No handler defined for dropdown: ${select.id}`);
                }
            });
        });

        // Attach event listeners to forward and back buttons
        const backButton = document.querySelectorAll(".button-group-box")[1].querySelector("button:first-child");
        const nextButton = document.querySelectorAll(".button-group-box")[1].querySelector("button:nth-child(2)");

        backButton.addEventListener("click", () => {
            if (count > 1) {
                count--;
                localStorage.setItem('count', count);
                clearFields();
                updateLabel();
                fetchWithTimeoutAndPrompt(count - 1);
            }
        });

        nextButton.addEventListener("click", () => {
            count++;
            localStorage.setItem('count', count);
            clearFields();
            updateLabel();
            fetchWithTimeoutAndPrompt(count - 1);
        });
      };
    </script>
  </body>
</html>
``` 