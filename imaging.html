<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A2 Notation Prototype</title>
  
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(ellipse at 60% 0%, #e6f4ea 0%, #f6f8fa 80%);
      color: #24292e;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .container {
      background-color: #fff;
      border-radius: 16px;
      box-shadow:
        0 8px 32px rgba(0,0,0,0.13),
        0 1.5px 8px 0 rgba(44,162,78,0.08),
        0 0.5px 1.5px 0 rgba(33,136,56,0.10);
      padding: 32px 32px 24px 32px;
      max-width: 1200px; /* Match newpage.html */
      min-width: 1000px;
      width: 100%;
      margin: 32px auto 0 auto;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border: 1.5px solid transparent;
      background-clip: padding-box;
      position: relative;
      z-index: 1;
    }
    
    /* Reduce padding for the second container */
    .container:nth-child(2) {
      padding: 16px 0px 38px 32px;
    }
    
    .container::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: -1;
      border-radius: 18px;
      padding: 2px;
      background: linear-gradient(120deg, #2da44e 0%, #e1e4e8 100%);
      opacity: 0.13;
      pointer-events: none;
    }
    .section-header {
      font-size: 1.3em;
      font-weight: bold;
      color: #24292e;
      margin-bottom: 8px;
      position: relative;
      padding-bottom: 6px;
      text-align: left;
      letter-spacing: 0.5px;
    }
    .section-header::after {
      content: "";
      display: block;
      margin: 8px 0 0 0;
      width: 48px;
      height: 3px;
      border-radius: 2px;
      background: linear-gradient(90deg, #2da44e 60%, #218838 100%);
      opacity: 0.7;
    }
    @media (max-width: 700px) {
      .container {
        padding: 18px 2vw 12px 2vw;
        max-width: 99vw;
      }
      .section-header {
        font-size: 1.1em;
      }
    }
    .imaging-row {
      display: flex;
      flex-direction: row;
      gap: 24px;
      width: 100%;
      justify-content: space-between;
      align-items: stretch; /* Ensure all children stretch to same height */
      margin-top: 18px;
    }
    .imaging-box {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex: 1 1 0;
      background: transparent;
      border-radius: 10px;
      box-shadow: none;
      padding: 12px 0;
      text-align: center;
      font-size: 1.1em;
      font-weight: 500;
      color: #218838;
      border: none;
      min-width: 0;
      box-sizing: border-box;
      width: 100%;   /* Ensure all boxes take full width of their flex space */
    }
    /* Reduce vertical padding ONLY for the first container's boxes */
    .container:first-of-type .imaging-box {
      padding-top: 12px;
      padding-bottom: 12px;
    }
    .imaging-box > * {
      max-width: 90%;
      width: 100%;
    }
    .imaging-box > .button {
      margin-top: 0;
      margin-bottom: 0;
      width: 48%;
    }
    .imaging-box > .button + .button {
      margin-top: 0;
      margin-left: 50%;
    }
    .imaging-box.buttons-horizontal {
      flex-basis: 36%; /* Make the middle box wider */
      max-width: 30%;
      min-width: 320px;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 0;
    }
    .imaging-box.buttons-horizontal .button {
      margin: 0 2%;
      width: 40%;
      align-self: center;
    }
    @media (max-width: 900px) {
      .container {
        padding: 18px 2vw 12px 2vw;
        max-width: 99vw;
        min-width: unset;
      }
      .imaging-row {
        flex-direction: column;
        gap: 16px;
      }
      .imaging-box {
        padding: 18px 0;
        font-size: 1em;
      }
    }
    .imaging-name-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      width: 100%;
      justify-content: center;
      gap: 12px;
    }
    .editable-name {
      flex: 0 1 80%;
      min-width: 0;
      font-size: 1.3em !important;
      font-weight: bold;
      color: #24292e;
      border: none;
      background-color: transparent;
      outline: none;
      text-align: center;
      width: 80%;
      cursor: text;
      transition: color 0.2s, font-weight 0.2s;
      margin-bottom: 8px;
    }
    .editable-name:focus {
      border-bottom: 2px solid #0969da;
    }
    .editable-name.saved {
      font-weight: bold;
      color: #0969da;
    }
    .entry-number {
      visibility: hidden;
      font-size: 0.4em;
      color: #57606a;
      margin-top: 4px;
    }
    .button, .green-button {
      padding: 12px 0;
      font-size: 1.08em;
      font-weight: 700;
      background: linear-gradient(90deg, #2da44e 60%, #218838 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.18s, transform 0.13s, box-shadow 0.18s;
      box-shadow: 0 2px 8px rgba(44, 162, 78, 0.08), 0 1.5px 6px 0 rgba(33,136,56,0.10);
      letter-spacing: 0.5px;
      outline: none;
      text-align: center;
      text-shadow: 0 1px 4px rgba(33,136,56,0.10);
      width: 48%;
      min-width: 120px;
      margin: 0 1%;
      display: inline-block;
      height: 48px;
      line-height: 1.2;
    }
    .button:hover, .green-button:hover, .button:focus, .green-button:focus {
      background: linear-gradient(90deg, #218838 60%, #2da44e 100%);
      transform: translateY(-2px) scale(1.035);
      box-shadow: 0 6px 18px rgba(44, 162, 78, 0.13), 0 2px 8px rgba(33,136,56,0.12), 0 0 12px 2px #2da44e33;
    }
    .button:active, .green-button:active {
      transform: scale(0.98);
    }
    .plus-button {
      flex: 0 1 40px;
      max-width: 40px;
      min-width: 40px;
      height: 40px;
      padding: 0;
      font-size: 1.5em;
      font-weight: bold;
      border-radius: 20%;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .plus-button:active {
      transform: scale(0.96);
    }
    .footer {
      text-align: center;
      font-size: 1.1em;
      color: #57606a;
      margin-top: 18px;
      padding: 10px 0 0 0;
      border-top: 1px solid #d0d7de;
      width: 100%;
      letter-spacing: 0.5px;
      box-shadow: 0 -2px 8px rgba(44,162,78,0.04);
    }
    .imaging-checkbox-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 24px;
      margin-top: 12px;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.08em;
      font-weight: 500;
      color: #24292e;
    }
    .imaging-checkbox-row input[type="checkbox"] {
      width: 40px;
      height: 40px;
      accent-color: #2da44e;
      cursor: pointer;
    }
    .imaging-dropdown-row {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 48px;
      margin-top: 12px;
    }
    .dropdown-label {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 1.08em;
      font-weight: 500;
      color: #24292e;
      gap: 6px;
    }
    .imaging-dropdown-row select {
      width: 160px;
      padding: 8px 12px;
      font-size: 1em;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #fff;
      color: #24292e;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 4px rgba(44, 162, 78, 0.04);
    }
    .imaging-dropdown-row.large,
    .imaging-checkbox-row.large {
      gap: 48px;
      margin-top: 0;
      width: 100%;
      justify-content: center;
      align-items: center;
      height: 100%;
    }
    .dropdown-label.large,
    .checkbox-label.large {
      font-size: 1.25em;
      gap: 12px;
    }
    .imaging-dropdown-row.large select.large {
      width: 200px;
      padding: 16px 18px;
      font-size: 1.15em;
    }
    .imaging-checkbox-row.large input[type="checkbox"] {
      width: 32px;
      height: 32px;
    }
    /* Multi-select dropdown styles */
    .multiselect {
      position: relative;
      display: inline-block;
      width: 160px;
    }
    
    .multiselect-header {
      width: 100%;
      padding: 8px 12px;
      font-size: 1em;
      border: 1px solid #d0d7de;
      border-radius: 6px;
      background-color: #fff;
      color: #24292e;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 1px 4px rgba(44, 162, 78, 0.04);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .multiselect-header:hover {
      border-color: #2da44e;
    }
    
    .multiselect-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d0d7de;
      border-top: none;
      border-radius: 0 0 6px 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      max-height: 200px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      width: 300px;
      min-width: 260px;
    }
    
    .multiselect-options.open {
      display: block;
    }
    
    .multiselect-option {
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.95em;
    }
    
    .multiselect-option:hover {
      background-color: #f6f8fa;
    }
    
    .multiselect-option input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #2da44e;
    }
    
    .dropdown-arrow {
      font-size: 0.8em;
      transition: transform 0.2s;
    }
    
    .dropdown-arrow.open {
      transform: rotate(180deg);
    }
    
    /* Ensure containers don't interfere with dropdown */
    .container {
      /* ...existing code... */
      z-index: 1;
      position: relative;
    }
    
    .container:nth-child(3) {
      z-index: 0; /* Lower z-index for subsequent containers */
    }
    
    .container:nth-child(4) {
      z-index: 0;
    }
    
    /* ...existing code... */
  </style>
</head>
<body>
  <div class="container">
    <div class="section-header">A2 Notation Prototype</div>
    <div class="imaging-row">
      <div class="imaging-box">
        <!-- Editable Name input from newpage.html -->
        <div class="imaging-name-row">
          <input id="editableName" class="editable-name" type="text" placeholder="Enter Notes Here Marie..." />
          <button id="addRowButton" class="button green-button plus-button">+</button>
        </div>
        <span id="entryNumber" class="entry-number"></span>
      </div>
      <div class="imaging-box buttons-horizontal">
        <button class="button green-button" id="backButton">&#8592; Back</button>
        <button class="button green-button" id="nextButton">Next &#8594;</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <div class="imaging-row">
      <div class="imaging-box">
        <div class="imaging-dropdown-row">
          <label class="dropdown-label">
            <span>Target:</span>
            <select>
              <option value="">Select...</option>
              <option value="1">Hi Marie</option>
              <option value="2">Don't use this yet lol!</option>
            </select>
          </label>
          <label class="dropdown-label">
            <span>Science Theme(s):</span>
            <div class="multiselect" id="scienceThemeSelect">
              <div class="multiselect-header">
                <span class="selected-text">Select themes...</span>
                <span class="dropdown-arrow">▼</span>
              </div>
              <div class="multiselect-options">
                <div class="multiselect-option">
                  <input type="checkbox" id="theme1" value="1. Impact History">
                  <label for="theme1">1. Impact History</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme2" value="2. Impact Flashes">
                  <label for="theme2">2. Impact Flashes</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme3" value="3. Volcanic History">
                  <label for="theme3">3. Volcanic History</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme4" value="4. Tectonics">
                  <label for="theme4">4. Tectonics</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme5" value="5. Color Provinces and Albedo">
                  <label for="theme5">5. Color Provinces and Albedo</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme6" value="6. Dust, Exosphere, and Deep Space">
                  <label for="theme6">6. Dust, Exosphere, and Deep Space</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme7" value="7. Earth Observations">
                  <label for="theme7">7. Earth Observations</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme8" value="8. Limb and Terminator">
                  <label for="theme8">8. Limb and Terminator</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme9" value="9. Landing Sites and Poles">
                  <label for="theme9">9. Landing Sites and Poles</label>
                </div>
                <div class="multiselect-option">
                  <input type="checkbox" id="theme10" value="10. Photometric Observations">
                  <label for="theme10">10. Photometric Observations</label>
                </div>
              </div>
            </div>
          </label>
        </div>
      </div>
      <div class="imaging-box">
        <div class="imaging-checkbox-row">
          <label class="checkbox-label">
            Something Funky?
            <input type="checkbox" id="c2box1cb2" name="c2box1group" />
          </label>
        </div>
      </div>
      <div class="imaging-box">
        <div class="imaging-checkbox-row">
          <label class="checkbox-label">
            <input type="checkbox" id="plannedCheckbox" name="plannedGroup" />
            Planned
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="unplannedCheckbox" name="plannedGroup" />
            Unplanned
          </label>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="section-header">Jeremy (Enter To Save)</div>
    <div style="display: flex; justify-content: center; width: 100%;">
      <input
        type="text"
        id="jeremyDescriptionInput"
        placeholder="Enter crew description..."
        style="
          width: 98%;
          padding: 14px 18px;
          font-size: 1.13em;
          border: 1.5px solid #d0d7de;
          border-radius: 8px;
          background: #f6f8fa;
          color: #24292e;
          box-shadow: 0 1px 4px rgba(44,162,78,0.06);
          outline: none;
          margin: 10px 0 8px 0;
          transition: border-color 0.2s, box-shadow 0.2s;
        "
        onfocus="this.style.borderColor='#2da44e';this.style.boxShadow='0 0 0 2px #2da44e33';"
        onblur="this.style.borderColor='#d0d7de';this.style.boxShadow='0 1px 4px rgba(44,162,78,0.06)';"
      />
    </div>
  </div>
  <div class="container">
    <div class="section-header">Kristina (Enter To Save)</div>
    <div style="display: flex; justify-content: center; width: 100%;">
      <input
        type="text"
        id="kristinaDescriptionInput"
        placeholder="Enter crew description..."
        style="
          width: 98%;
          padding: 14px 18px;
          font-size: 1.13em;
          border: 1.5px solid #d0d7de;
          border-radius: 8px;
          background: #f6f8fa;
          color: #24292e;
          box-shadow: 0 1px 4px rgba(44,162,78,0.06);
          outline: none;
          margin: 10px 0 8px 0;
          transition: border-color 0.2s, box-shadow 0.2s;
        "
        onfocus="this.style.borderColor='#2da44e';this.style.boxShadow='0 0 0 2px #2da44e33';"
        onblur="this.style.borderColor='#d0d7de';this.style.boxShadow='0 1px 4px rgba(44,162,78,0.06)';"
      />
    </div>
  </div>
  <div class="container">
    <div class="section-header">Jackie (Enter To Save)</div>
    <div style="display: flex; justify-content: center; width: 100%;">
      <input
        type="text"
        id="nameDescriptionInput"
        placeholder="Enter crew description..."
        style="
          width: 98%;
          padding: 14px 18px;
          font-size: 1.13em;
          border: 1.5px solid #d0d7de;
          border-radius: 8px;
          background: #f6f8fa;
          color: #24292e;
          box-shadow: 0 1px 4px rgba(44,162,78,0.06);
          outline: none;
          margin: 10px 0 8px 0;
          transition: border-color 0.2s, box-shadow 0.2s;
        "
        onfocus="this.style.borderColor='#2da44e';this.style.boxShadow='0 0 0 2px #2da44e33';"
        onblur="this.style.borderColor='#d0d7de';this.style.boxShadow='0 1px 4px rgba(44,162,78,0.06)';"
      />
    </div>
  </div>
  <div class="container">
    <div class="section-header">Jenny (Enter To Save)</div>
    <div style="display: flex; justify-content: center; width: 100%;">
      <input
        type="text"
        id="otherNameDescriptionInput"
        placeholder="Enter crew description..."
        style="
          width: 98%;
          padding: 14px 18px;
          font-size: 1.13em;
          border: 1.5px solid #d0d7de;
          border-radius: 8px;
          background: #f6f8fa;
          color: #24292e;
          box-shadow: 0 1px 4px rgba(44,162,78,0.06);
          outline: none;
          margin: 10px 0 8px 0;
          transition: border-color 0.2s, box-shadow 0.2s;
        "
        onfocus="this.style.borderColor='#2da44e';this.style.boxShadow='0 0 0 2px #2da44e33';"
        onblur="this.style.borderColor='#d0d7de';this.style.boxShadow='0 1px 4px rgba(44,162,78,0.06)';"
      />
    </div>
  </div>
  <div class="container">
    <div class="section-header">Observation Characteristics</div>
    <div style="display: flex; justify-content: center; width: 100%;">
      <div style="display: flex; width: 98%; gap: 50px; justify-content: space-between;">
        <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
          <label for="imgCharDropdown" style="font-weight: 500; margin-bottom: 6px; color: #24292e;">Image Type:</label>
          <select id="imgCharDropdown" style="width: 100%; padding: 10px 12px; border: 1.5px solid #d0d7de; border-radius: 8px; background: #f6f8fa; font-size: 1em; color: #24292e;">
            <option value="">Select Image Type...</option>
            <option value="Normal">Normal</option>
            <option value="Zoomed">Zoomed</option>
            <option value="Mosaic">Mosaic</option>
          </select>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
          <label for="imgCharInput1" style="font-weight: 500; margin-bottom: 6px; color: #24292e;">Notes:</label>
          <input id="imgCharInput1" type="text" placeholder="Enter Image Notes..." style="width: 100%; padding: 10px 12px; border: 1.5px solid #d0d7de; border-radius: 8px; background: #f6f8fa; font-size: 1em; color: #24292e;" />
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
          <label for="imgCharInput2" style="font-weight: 500; margin-bottom: 6px; color: #24292e;"></label>
          <input id="imgCharInput2" type="text" placeholder="..." style="width: 100%; padding: 10px 12px; border: 1.5px solid #d0d7de; border-radius: 8px; background: #f6f8fa; font-size: 1em; color: #24292e;" />
        </div>
      </div>
    </div>
  </div>
  <div class="footer" id="footerImageCount"></div>
</body>
<script>
  // Google Sheet ID (same as newpage.html)
  const SPREADSHEET_ID = '1efR88nP511yGEPgjsR9KcT0nE2TQImzuxyYYZ6uUKGo'; 

  // On page load, clear token and prompt fresh Google sign in
  window.onload = function() {
    // Clear any existing token from localStorage
    localStorage.removeItem('accessToken');
    window.accessToken = null;

    // Initialize Google Identity Services
    initTokenClient();

    // Immediately prompt for Google sign-in
    if (tokenClient) {
      tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
      // If GIS not loaded yet, wait a bit and try again
      setTimeout(() => {
        initTokenClient();
        if (tokenClient) {
          tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
          alert("Google Sign-In failed to load. Please refresh the page.");
        }
      }, 1000);
    }
  };

  // GIS token management logic
  let tokenClient;
  const CLIENT_ID = '263288053429-39j61v5mij7mhrtqg9peqov1i33nedc6.apps.googleusercontent.com';

  function initTokenClient() {
    if (typeof google !== 'undefined' && google.accounts) {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/spreadsheets',
        callback: (tokenResponse) => {
          if (tokenResponse.access_token) {
            window.accessToken = tokenResponse.access_token;
            localStorage.setItem('accessToken', tokenResponse.access_token);
            console.log("Successfully signed in with Google");
            
            // Initialize the page after successful sign-in
            initializePage();
          } else {
            alert("Google sign-in failed. Please try again.");
            window.location.href = 'index.html';
          }
        }
      });
    }
  }

  // Multi-select dropdown functionality
  function setupMultiSelect() {
    const multiselect = document.getElementById('scienceThemeSelect');
    const header = multiselect.querySelector('.multiselect-header');
    const options = multiselect.querySelector('.multiselect-options');
    const arrow = multiselect.querySelector('.dropdown-arrow');
    const selectedText = multiselect.querySelector('.selected-text');
    const checkboxes = multiselect.querySelectorAll('input[type="checkbox"]');
    
    let selectedThemes = [];
    let userInteracted = false;

    // Toggle dropdown
    header.addEventListener('click', () => {
      options.classList.toggle('open');
      arrow.classList.toggle('open');
    });

    // Update selected text display only
    function updateSelectedText() {
      if (selectedThemes.length === 0) {
        selectedText.textContent = 'Select themes...';
      } else if (selectedThemes.length === 1) {
        selectedText.textContent = selectedThemes[0];
      } else {
        selectedText.textContent = `${selectedThemes.length} themes selected`;
      }
    }

    // Handle checkbox changes
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        userInteracted = true;
        const value = checkbox.value;
        
        if (checkbox.checked) {
          // Add to list if not already present
          if (!selectedThemes.includes(value)) {
            selectedThemes.push(value);
          }
        } else {
          // Remove from list
          selectedThemes = selectedThemes.filter(theme => theme !== value);
        }
        
        updateSelectedText();
      });
    });

    // Write to sheet when clicking outside (only if user interacted)
    document.addEventListener('click', (e) => {
      if (!multiselect.contains(e.target)) {
        // Close dropdown
        options.classList.remove('open');
        arrow.classList.remove('open');
        
        // Write to sheet only if user interacted with checkboxes
        if (userInteracted) {
          const selectedString = selectedThemes.join(', ');
          writeToSheet2(imageCount - 1, 13, selectedString).then(() => {
            flashGreen(multiselect);
          }).catch(err => {
            console.error('Failed to write themes to sheet:', err);
          });
          userInteracted = false; // Reset interaction flag
        }
      }
    });

    // Public method to set themes programmatically (for prefilling)
    multiselect.setThemes = function(themes) {
      selectedThemes = themes.slice(); // Copy array
      
      // Clear all checkboxes first
      checkboxes.forEach(cb => cb.checked = false);
      
      // Check the ones that match
      themes.forEach(theme => {
        const checkbox = Array.from(checkboxes).find(cb => cb.value === theme);
        if (checkbox) checkbox.checked = true;
      });
      
      updateSelectedText();
    };

    // Public method to get current themes
    multiselect.getThemes = function() {
      return selectedThemes.slice(); // Return copy of array
    };
  }

  // Initialize page components after successful authentication
  function initializePage() {
    // Start periodic token validity polling
    startTokenValidityPolling();

    initializeImageNameAndEntry();
    updateFooterImageCount();
    setupBackNextButtons();
    setupExclusiveCheckboxesContainer2Box1();
    setupMultiSelect(); // Add this line
    setupWriteHandlers();
    fetchAndPrefillRow(imageCount - 1);
  }

  // Refresh access token
  function refreshAccessToken(callback) {
    if (!tokenClient) {
      alert("Session expired. Please sign in again.");
      window.location.href = 'index.html';
      return;
    }
    tokenClient.callback = (tokenResponse) => {
      if (tokenResponse.access_token) {
        window.accessToken = tokenResponse.access_token;
        localStorage.setItem('accessToken', tokenResponse.access_token);
        if (callback) callback();
      } else {
        alert("Session expired. Please sign in again.");
        localStorage.removeItem('accessToken');
        window.location.href = 'index.html';
      }
    };
    tokenClient.requestAccessToken({ prompt: '' });
  }

  // Safe API call wrapper
  function safeApiCall(apiFunction) {
    if (!window.accessToken) {
      return new Promise((resolve, reject) => {
        if (tokenClient) {
          tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
          alert("Sign-in required. Please refresh the page.");
          reject("No access token");
        }
      });
    }
    return apiFunction().catch(err => {
      if (err?.status === 401 || (err?.message && err.message.includes('401'))) {
        return new Promise((resolve, reject) => {
          refreshAccessToken(() => {
            apiFunction().then(resolve).catch(reject);
          });
        });
      } else {
        console.error("API error:", err);
        throw err;
      }
    });
  }

  // Editable name logic for Imaging (Sheet2)
  // You can adjust the SHEET2_ID and range as needed
  const SHEET2_ID = 'Sheet2';
  let imageCount = 1;

  // Function to write the updated image name to Sheet2
  function writeImageNameToSheet(rowIndex, name) {
    const range = `${SHEET2_ID}!A${rowIndex + 2}:A${rowIndex + 2}`;
    const values = [[name]];
    return safeApiCall(() =>
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=RAW`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${window.accessToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ values }),
      })
      .then((response) => {
        if (!response.ok) throw response;
        return response.json();
      })
      .then((data) => {
        console.log("Image name updated successfully:", data);
      })
      .catch((error) => {
        console.error("Failed to update image name:", error);
      })
    );
  }

  // Initialize the editable name and entry number for Imaging
  function initializeImageNameAndEntry() {
    const editableName = document.getElementById("editableName");
    const entryNumber = document.getElementById("entryNumber");

    // Optionally fetch and display the name for the current row here

    // Update the entry number (if you want to show it)
    entryNumber.innerText = `Entry #${imageCount}`;

    // Add event listener for editing the name
    editableName.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const updatedName = editableName.value.trim();
        if (updatedName) {
          writeImageNameToSheet(imageCount - 1, updatedName).then(() => {
            // Apply the "saved" style
            editableName.classList.add("saved");
            editableName.style.color = "#0969da";
            setTimeout(() => {
              editableName.classList.remove("saved");
              editableName.style.color = "#24292e";
            }, 2000);
          });
        }
      }
    });
  }

  // Define imageCount and display in footer
  function updateFooterImageCount() {
    const footer = document.getElementById('footerImageCount');
    if (footer) {
      footer.textContent = `#${imageCount}`;
    }
  }

  // Clear all inputs and selections
  function clearAllInputs() {
    // Clear all text inputs
    document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
    // Clear all selects
    document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
    // Clear all checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    // Clear multi-select dropdown
    const multiselect = document.getElementById('scienceThemeSelect');
    if (multiselect && multiselect.setThemes) {
      multiselect.setThemes([]);
    }
  }

  // Fetch and pre-fill information from the spreadsheet for the given rowIndex (0-based)
  function fetchAndPrefillRow(rowIndex) {
    safeApiCall(() => doPrefillRow(rowIndex));
  }

  function doPrefillRow(rowIndex) {
    const range = `${SHEET2_ID}!A${rowIndex + 2}:Q${rowIndex + 2}`; // Extended to column Q
    return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}`, {
      headers: {
        "Authorization": `Bearer ${window.accessToken}`,
      }
    })
    .then(response => {
      if (!response.ok) throw response;
      return response.json();
    })
    .then(data => {
      const row = (data.values && data.values[0]) ? data.values[0] : [];

      // Updated Column mapping (0-based):
      // 0: Name, 1: Start Time, 2: End Time, 3: Target, 4: Planned/Unplanned, 5: Something Funky, 6: Jeremy, 7: Kristina, 8: Name, 9: Other Name, 10: Other Observers, 11: Image Target, 12: Unit, 13: Science Themes

      // Editable name
      document.getElementById("editableName").value = row[0] || "";

      // Target (dropdown 1)
      const targetSelect = document.querySelector('.imaging-dropdown-row select');
      if (targetSelect && row[3]) {
        let found = false;
        for (let i = 0; i < targetSelect.options.length; i++) {
          if (targetSelect.options[i].value === row[3]) {
            targetSelect.selectedIndex = i;
            found = true;
            break;
          }
        }
        if (!found) targetSelect.selectedIndex = 0;
      }

      // Something Funky checkbox
      document.getElementById('c2box1cb2').checked = (row[5] === "YES");

      // Planned/Unplanned
      document.getElementById('plannedCheckbox').checked = (row[4] === "Planned");
      document.getElementById('unplannedCheckbox').checked = (row[4] === "Unplanned");

      // Crew Description inputs with corrected column mapping
      document.getElementById("jeremyDescriptionInput").value = row[6] || "";
      document.getElementById("kristinaDescriptionInput").value = row[7] || "";
      document.getElementById("nameDescriptionInput").value = row[8] || "";
      document.getElementById("otherNameDescriptionInput").value = row[9] || "";

      // Image Type dropdown
      const imgTypeSelect = document.getElementById("imgCharDropdown");
      if (imgTypeSelect && row[10]) {
        let found = false;
        for (let i = 0; i < imgTypeSelect.options.length; i++) {
          if (imgTypeSelect.options[i].value === row[10]) {
            imgTypeSelect.selectedIndex = i;
            found = true;
            break;
          }
        }
        if (!found) imgTypeSelect.selectedIndex = 0;
      }

      // Image Target
      document.getElementById("imgCharInput1").value = row[11] || "";

      // Unit
      document.getElementById("imgCharInput2").value = row[12] || "";

      // Science Themes (col 13) - handle multi-select
      const scienceThemes = row[13] || "";
      const selectedThemes = scienceThemes.split(', ').filter(theme => theme.trim());
      const multiselect = document.getElementById('scienceThemeSelect');
      
      // Use the public method to set themes
      if (multiselect && multiselect.setThemes) {
        multiselect.setThemes(selectedThemes);
      }
    })
    .catch(error => {
      console.error("Failed to fetch row data:", error);
    });
  }

  // Back/Next button logic
  function setupBackNextButtons() {
    const backBtn = document.getElementById('backButton');
    const nextBtn = document.getElementById('nextButton');
    if (backBtn) {
      backBtn.addEventListener('click', () => {
        if (imageCount > 1) {
          imageCount--;
          updateFooterImageCount();
          clearAllInputs();
          fetchAndPrefillRow(imageCount - 1);
        }
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        imageCount++;
        updateFooterImageCount();
        clearAllInputs();
        fetchAndPrefillRow(imageCount - 1);
      });
    }
  }

  // Only allow one checkbox to be checked at a time in container 2, box 1 and planned/unplanned
  function setupExclusiveCheckboxesContainer2Box1() {
    // EV1/EV2
    const cb1 = document.getElementById('c2box1cb1');
    const cb2 = document.getElementById('c2box1cb2');
    if (cb1 && cb2) {
      cb1.addEventListener('change', () => { if (cb1.checked) cb2.checked = false; });
      cb2.addEventListener('change', () => { if (cb2.checked) cb1.checked = false; });
    }
    // Planned/Unplanned
    const planned = document.getElementById('plannedCheckbox');
    const unplanned = document.getElementById('unplannedCheckbox');
    if (planned && unplanned) {
      planned.addEventListener('change', () => { if (planned.checked) unplanned.checked = false; });
      unplanned.addEventListener('change', () => { if (unplanned.checked) planned.checked = false; });
    }
  }

  // Utility: flash input green then back to original color
  function flashGreen(element) {
    const origColor = element.style.color;
    element.style.color = "#218838";
    setTimeout(() => {
      element.style.color = origColor || "#24292e";
    }, 800);
  }

  // Utility: flash button green background then back to white
  function flashButtonGreen(button) {
    const origBg = button.style.background;
    const origColor = button.style.color;
    button.style.background = "#218838";
    button.style.color = "#fff";
    setTimeout(() => {
      button.style.background = origBg || "";
      button.style.color = origColor || "#fff";
    }, 800);
  }

  // --- WRITE FUNCTIONS ---

  // Write a value to a specific column (colIndex: 0-based, e.g. 0 = A, 1 = B, ...)
  function writeToSheet2(rowIndex, colIndex, value) {
    const colLetter = String.fromCharCode(65 + colIndex); // A, B, C, ...
    const range = `${SHEET2_ID}!${colLetter}${rowIndex + 2}:${colLetter}${rowIndex + 2}`;
    const values = [[value]];
    return safeApiCall(() =>
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=RAW`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${window.accessToken}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ values }),
      })
      .then(response => {
        if (!response.ok) throw response;
        return response.json();
      })
    );
  }

  // --- EVENT HANDLERS FOR WRITING ---
  function setupWriteHandlers() {
    // Editable Name (col 0)
    const editableName = document.getElementById("editableName");
    editableName.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const val = editableName.value.trim();
        writeToSheet2(imageCount - 1, 0, val).then(() => flashGreen(editableName));
      }
    });

    // Start/End Time buttons (col 1 and 2)
    const startBtn = document.getElementById('startTimeButton');
    const endBtn = document.getElementById('endTimeButton');
    if (startBtn) {
      startBtn.addEventListener("click", () => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        writeToSheet2(imageCount - 1, 1, timeStr).then(() => flashButtonGreen(startBtn));
      });
    }
    if (endBtn) {
      endBtn.addEventListener("click", () => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        writeToSheet2(imageCount - 1, 2, timeStr).then(() => flashButtonGreen(endBtn));
      });
    }

    // Target dropdown (col 3)
    const targetSelect = document.querySelector('.imaging-dropdown-row select');
    targetSelect.addEventListener("change", () => {
      const val = targetSelect.value;
      if (val) {
        writeToSheet2(imageCount - 1, 3, val).then(() => flashGreen(targetSelect));
      }
    });

    // Planned/Unplanned (col 4)
    const planned = document.getElementById('plannedCheckbox');
    const unplanned = document.getElementById('unplannedCheckbox');
    planned.addEventListener("change", () => {
      if (planned.checked) {
        writeToSheet2(imageCount - 1, 4, "Planned").then(() => flashGreen(planned.parentElement));
      }
    });
    unplanned.addEventListener("change", () => {
      if (unplanned.checked) {
        writeToSheet2(imageCount - 1, 4, "Unplanned").then(() => flashGreen(unplanned.parentElement));
      }
    });

    // Something Funky (col 5)
    const funkyCheckbox = document.getElementById('c2box1cb2');
    funkyCheckbox.addEventListener("change", () => {
      const val = funkyCheckbox.checked ? "YES" : "";
      writeToSheet2(imageCount - 1, 5, val).then(() => flashGreen(funkyCheckbox.parentElement));
    });

    // Jeremy Description (col 6)
    const jeremyDesc = document.getElementById("jeremyDescriptionInput");
    jeremyDesc.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const val = jeremyDesc.value.trim();
        writeToSheet2(imageCount - 1, 6, val).then(() => flashGreen(jeremyDesc));
      }
    });

    // Kristina Description (col 7)
    const kristinaDesc = document.getElementById("kristinaDescriptionInput");
    kristinaDesc.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const val = kristinaDesc.value.trim();
        writeToSheet2(imageCount - 1, 7, val).then(() => flashGreen(kristinaDesc));
      }
    });

    // Name Description (col 8)
    const nameDesc = document.getElementById("nameDescriptionInput");
    nameDesc.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const val = nameDesc.value.trim();
        writeToSheet2(imageCount - 1, 8, val).then(() => flashGreen(nameDesc));
      }
    });

    // Other Name Description (col 9)
    const otherNameDesc = document.getElementById("otherNameDescriptionInput");
    otherNameDesc.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const val = otherNameDesc.value.trim();
        writeToSheet2(imageCount - 1, 9, val).then(() => flashGreen(otherNameDesc));
      }
    });

    // Other Observers (col 10)
    const imgTypeSelect = document.getElementById("imgCharDropdown");
    imgTypeSelect.addEventListener("change", () => {
      const val = imgTypeSelect.value;
      if (val) {
        writeToSheet2(imageCount - 1, 10, val).then(() => flashGreen(imgTypeSelect));
      }
    });

    // Image Target (col 11)
    const targetInput = document.getElementById("imgCharInput1");
    targetInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const val = targetInput.value.trim();
        writeToSheet2(imageCount - 1, 11, val).then(() => flashGreen(targetInput));
      }
    });

    // Unit (col 12)
    const unitInput = document.getElementById("imgCharInput2");
    unitInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter" || event.keyCode === 13) {
        const val = unitInput.value.trim();
        writeToSheet2(imageCount - 1, 12, val).then(() => flashGreen(unitInput));
      }
    });

    // Multi-select themes handling (col 13) - moved inside setupWriteHandlers
    const multiselect = document.getElementById('scienceThemeSelect');
    if (multiselect) {
      // Write to sheet when clicking outside (only if user interacted) col 13
      document.addEventListener('click', (e) => {
        if (!multiselect.contains(e.target)) {
          // Get current themes if the multiselect is set up
          if (multiselect.getThemes) {
            const selectedString = multiselect.getThemes().join(', ');
            if (selectedString !== multiselect.lastSavedValue) {
              writeToSheet2(imageCount - 1, 13, selectedString).then(() => {
                flashGreen(multiselect);
                multiselect.lastSavedValue = selectedString;
              }).catch(err => {
                console.error('Failed to write themes to sheet:', err);
              });
            }
          }
        }
      });
    }
  }

  // Periodically check token validity every 30 seconds
  function startTokenValidityPolling() {
    setInterval(() => {
      // Try a lightweight API call to check token validity
      safeApiCall(() =>
        fetch("https://sheets.googleapis.com/v4/spreadsheets/" + SPREADSHEET_ID + "?fields=spreadsheetId", {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${window.accessToken}`,
          }
        })
        .then(res => {
          if (!res.ok) throw res;
          return res.json();
        })
      ).catch(() => {
        // If token is invalid, safeApiCall will handle refresh
      });
    }, 30000); // 30 seconds
  }
    setInterval(() => {
      // Try a lightweight API call to check token validity
      safeApiCall(() =>
        fetch("https://sheets.googleapis.com/v4/spreadsheets/" + SPREADSHEET_ID + "?fields=spreadsheetId", {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${window.accessToken}`,
          }
        })
        .then(res => {
          if (!res.ok) throw res;
          return res.json();
        })
      ).catch(() => {
        // If token is invalid, safeApiCall will handle refresh
      });
    }, 30000); // 30 seconds
</script>
</html>
</script>
</html>
</script>
</html>

